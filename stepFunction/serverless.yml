service: service-orders-pop-and-dispatch

provider:
  name: aws
  runtime: python3.13
  region: us-east-1
  memorySize: 256
  timeout: 20
  iam:
    role: arn:aws:iam::645337731455:role/LabRole
  environment:
    STATE_MACHINE_ARN: arn:aws:states:us-east-1:645337731455:stateMachine:Handler_pedidos
    QUEUE_URL: https://sqs.us-east-1.amazonaws.com/645337731455/Cola_registro_pedidos
    HIST_TABLE: t_historial_pedidos   # <— NUEVO

  httpApi:
    cors: true

functions:
  popAndDispatch:
    handler: pop_and_dispatch.handler
    description: "HTTP -> pop N mensajes de SQS y enviar 'estado' (string) a Step Functions"
    timeout: 30
    events:
      - httpApi:
          path: /pedidos/pop
          method: POST

resources:
  Resources:
    HistorialPedidosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: t_historial_pedidos
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id_pedido     # PK
            AttributeType: S
          - AttributeName: createdAt     # SK (orden cronológico)
            AttributeType: S
        KeySchema:
          - AttributeName: id_pedido
            KeyType: HASH
          - AttributeName: createdAt
            KeyType: RANGE
        # (Opcional) TTL si quieres expirar históricos:
        # TimeToLiveSpecification:
        #   AttributeName: ttl
        #   Enabled: true

package:
  patterns:
    - '!**/*'
    - 'pop_and_dispatch.py'
